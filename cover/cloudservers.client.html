<html>
<head>
<title>cloudservers.client</title>
</head>
<body>
cloudservers.client
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 39 lines<br/>
Missed: 12 lines<br/>
Skipped 21 lines<br/>
Percent: 76 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre> 1</pre></span><pre>import httplib2</pre></div>
<div class="cov"><span class="num"><pre> 2</pre></span><pre>try:</pre></div>
<div class="cov"><span class="num"><pre> 3</pre></span><pre>    import json</pre></div>
<div class="nocov"><span class="num"><pre> 4</pre></span><pre>except ImportError:</pre></div>
<div class="nocov"><span class="num"><pre> 5</pre></span><pre>    import simplejson as json</pre></div>
<div class="skip"><span class="num"><pre> 6</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 7</pre></span><pre>from . import exceptions</pre></div>
<div class="skip"><span class="num"><pre> 8</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 9</pre></span><pre>class CloudServersClient(httplib2.Http):</pre></div>
<div class="skip"><span class="num"><pre>10</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>11</pre></span><pre>    AUTH_URL = 'https://auth.api.rackspacecloud.com/v1.0'</pre></div>
<div class="skip"><span class="num"><pre>12</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>13</pre></span><pre>    def __init__(self, user, apikey):</pre></div>
<div class="cov"><span class="num"><pre>14</pre></span><pre>        super(CloudServersClient, self).__init__()</pre></div>
<div class="cov"><span class="num"><pre>15</pre></span><pre>        self.user = user</pre></div>
<div class="cov"><span class="num"><pre>16</pre></span><pre>        self.apikey = apikey</pre></div>
<div class="skip"><span class="num"><pre>17</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>18</pre></span><pre>        self.management_url = None</pre></div>
<div class="cov"><span class="num"><pre>19</pre></span><pre>        self.auth_token = None</pre></div>
<div class="skip"><span class="num"><pre>20</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre>21</pre></span><pre>        # httplib2 overrides</pre></div>
<div class="cov"><span class="num"><pre>22</pre></span><pre>        self.force_exception_to_status_code = True</pre></div>
<div class="skip"><span class="num"><pre>23</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>24</pre></span><pre>    def request(self, *args, **kwargs):</pre></div>
<div class="cov"><span class="num"><pre>25</pre></span><pre>        if 'body' in kwargs:</pre></div>
<div class="cov"><span class="num"><pre>26</pre></span><pre>            kwargs.setdefault('headers', {})['Content-Type'] = 'application/json'</pre></div>
<div class="cov"><span class="num"><pre>27</pre></span><pre>            kwargs['body'] = json.dumps(kwargs['body'])</pre></div>
<div class="skip"><span class="num"><pre>28</pre></span><pre>            </pre></div>
<div class="cov"><span class="num"><pre>29</pre></span><pre>        resp, body = super(CloudServersClient, self).request(*args, **kwargs)</pre></div>
<div class="cov"><span class="num"><pre>30</pre></span><pre>        body = json.loads(body) if body else None</pre></div>
<div class="skip"><span class="num"><pre>31</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>32</pre></span><pre>        if resp.status in (400, 401, 403, 404, 413, 500):</pre></div>
<div class="cov"><span class="num"><pre>33</pre></span><pre>            raise exceptions.from_response(resp, body)</pre></div>
<div class="skip"><span class="num"><pre>34</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>35</pre></span><pre>        return resp, body</pre></div>
<div class="skip"><span class="num"><pre>36</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>37</pre></span><pre>    def _cs_request(self, url, method, **kwargs):</pre></div>
<div class="cov"><span class="num"><pre>38</pre></span><pre>        if not self.management_url:</pre></div>
<div class="nocov"><span class="num"><pre>39</pre></span><pre>            self.authenticate()</pre></div>
<div class="skip"><span class="num"><pre>40</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>41</pre></span><pre>        # Perform the request once. If we get a 401 back then it</pre></div>
<div class="skip"><span class="num"><pre>42</pre></span><pre>        # might be because the auth token expired, so try to</pre></div>
<div class="skip"><span class="num"><pre>43</pre></span><pre>        # re-authenticate and try again. If it still fails, bail.</pre></div>
<div class="cov"><span class="num"><pre>44</pre></span><pre>        try:</pre></div>
<div class="cov"><span class="num"><pre>45</pre></span><pre>            kwargs.setdefault('headers', {})['X-Auth-Token'] = self.auth_token</pre></div>
<div class="cov"><span class="num"><pre>46</pre></span><pre>            resp, body = self.request(self.management_url + url, method, **kwargs)</pre></div>
<div class="cov"><span class="num"><pre>47</pre></span><pre>            return resp, body</pre></div>
<div class="nocov"><span class="num"><pre>48</pre></span><pre>        except exceptions.Unauthorized, ex:</pre></div>
<div class="nocov"><span class="num"><pre>49</pre></span><pre>            try:</pre></div>
<div class="nocov"><span class="num"><pre>50</pre></span><pre>                self.authenticate()</pre></div>
<div class="nocov"><span class="num"><pre>51</pre></span><pre>                resp, body = self.request(self.management_url + url, method, **kwargs)</pre></div>
<div class="nocov"><span class="num"><pre>52</pre></span><pre>                return resp, body</pre></div>
<div class="nocov"><span class="num"><pre>53</pre></span><pre>            except exceptions.Unauthorized:</pre></div>
<div class="nocov"><span class="num"><pre>54</pre></span><pre>                raise ex</pre></div>
<div class="skip"><span class="num"><pre>55</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>56</pre></span><pre>    def get(self, url, **kwargs):</pre></div>
<div class="cov"><span class="num"><pre>57</pre></span><pre>        return self._cs_request(url, 'GET', **kwargs)</pre></div>
<div class="skip"><span class="num"><pre>58</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>59</pre></span><pre>    def post(self, url, **kwargs):</pre></div>
<div class="cov"><span class="num"><pre>60</pre></span><pre>        return self._cs_request(url, 'POST', **kwargs)</pre></div>
<div class="skip"><span class="num"><pre>61</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>62</pre></span><pre>    def put(self, url, **kwargs):</pre></div>
<div class="nocov"><span class="num"><pre>63</pre></span><pre>        return self._cs_request(url, 'PUT', **kwargs)</pre></div>
<div class="skip"><span class="num"><pre>64</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>65</pre></span><pre>    def delete(self, url, **kwargs):</pre></div>
<div class="nocov"><span class="num"><pre>66</pre></span><pre>        return self._cs_request(url, 'DELETE', **kwargs)</pre></div>
<div class="skip"><span class="num"><pre>67</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>68</pre></span><pre>    def authenticate(self):</pre></div>
<div class="cov"><span class="num"><pre>69</pre></span><pre>        headers = {'X-Auth-User': self.user, 'X-Auth-Key': self.apikey}</pre></div>
<div class="cov"><span class="num"><pre>70</pre></span><pre>        resp, body = self.request(self.AUTH_URL, 'GET', headers=headers)</pre></div>
<div class="cov"><span class="num"><pre>71</pre></span><pre>        self.management_url = resp['x-server-management-url']</pre></div>
<div class="cov"><span class="num"><pre>72</pre></span><pre>        self.auth_token = resp['x-auth-token']</pre></div>
</div>
</body>
</html>
